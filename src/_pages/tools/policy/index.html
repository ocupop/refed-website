---
layout: policy_tool
title: Policy Tool
permalink: /tools/policy/

tool: U.S. Food Waste Policy Finder
---

{% include policy/tooltip.html %}

{% include policy/policynav_map.html %}

<section class="alt">
  {% include policy/explore_state_navigation.html %}
</section>
<section class="transparent">
  {% include policy/page_header.html %}
  <div class="container-fluid">
    <div class="row middle-xs center-xs">
      <div class="col-xs-12">
        <div id="map"></div>
        <div id="map-instructions">
          <div class="content">
            <h4>U.S. Food Waste Policy Finder</h4>
            <p>Use this tool to research current food waste policy at the federal and state levels and to discover best practices and recommendations for policy improvements that will support more food waste prevention, recovery and recycling.</p>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% include_relative _map_legend.html %}
</section>



<script>

  $('#tooltip .close').on('click', function() {
    $('#tooltip').removeClass('active');
  });
  $('#state-select').change(function(){
    var value = $(this).val();
    window.console.log('value', value);
    var url = $(this).val(); // get selected value
      if (url) { // require a URL
          window.location = url; // redirect
      }
      return false;
  });

  $('.collapse').on('show.bs.collapse', function() {
    $('#policynav .collapse').not($(this)).collapse('hide');
  });

  $('.map-filter, .map-subfilter').on('click', function() {
    var $root = $(this).closest('.root');
    clearFilters($root);
  });

  $('.map-filter, .map-subfilter').on('change', function(e) {
    var checked = $(this).prop("checked"),
        container = $(this).parent(),
        siblings = container.siblings();
    // window.console.log("CONTAINER: ", container);

    container.find('input[type="checkbox"]').prop({
      indeterminate: false,
      checked: checked
    });

    function checkSiblings(el) {

      var parent = el.parent().parent(),
          all = true;

      el.siblings().each(function() {
        return all = ($(this).children('input[type="checkbox"]').prop("checked") === checked);
      });

      if (all && checked) {

        parent.children('input[type="checkbox"]').prop({
          indeterminate: false,
          checked: checked
        });

        checkSiblings(parent);

      } else if (all && !checked) {

        parent.children('input[type="checkbox"]').prop("checked", checked);
        parent.children('input[type="checkbox"]').prop("indeterminate", (parent.find('input[type="checkbox"]:checked').length > 0));
        checkSiblings(parent);

      } else {

        el.parents("li").children('input[type="checkbox"]').prop({
          indeterminate: true,
          checked: false
        });

      }

    }

    checkSiblings(container);
    updateMap();
  });

  $('.study-filter').on('click', function() {
    var type = this.checked ? this.value : false;
    if(type) {
      showStudies(type);
    } else {
      hideStudies();
    }
    // var $root = $(this).closest('.root');
    // clearFilters($root);
    // 
  });

  function hideStudies() {
    $("#map").removeClass('recycle recovery prevention');
  }

  function showStudies(type) {
    $('#map')
      .removeClass('recycle recovery prevention')
      .addClass(type);
  }

  function clearFilters(activeRoot) {
    $(".root").not(activeRoot).each(function() {
      $(this).find('input[type="checkbox"]').prop({
        indeterminate: false,
        checked: false
      });
    });
    var category = $(activeRoot).data('category');
    $('.states')
      .removeClass('recycle recovery prevention')
      .addClass(category);
  }

  function clearLevels() {
    $('path.states').removeClass(function (index, css) {
      return (css.match (/(^|\s)level-\S+/g) || []).join(' ');
    });
  }

  function getLevel(array, state) {
    return array.filter(item => item == state).length;
  }

  function updateMap() {
    var activeStates = [];
    $(".map-subfilter").each(function() {
      if($(this).is(':checked')) {
        var states = $(this).data('states');
        states.forEach(function(state) {
          activeStates.push(state);
        });
      }
    });
    clearLevels();
    activeStates.forEach(function(state) {
      $('#'+state).addClass('level-'+getLevel(activeStates, state));
      // console.log(state, getLevel(activeStates, state));
    });
  }


</script>


<!-- Map -->
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://d3js.org/topojson.v1.min.js"></script>
<script src="http://d3js.org/queue.v1.min.js"></script>

<script type="text/javascript">
  String.prototype.trim = function(){
    return this.replace(" ", "-").toLowerCase();
  };

  /*  This visualization was made possible by modifying code provided by:


  */
  var width = 960,
      height = 500;

  var svg = d3.select("#map")
        .append("svg")
        .attr("preserveAspectRatio", "xMinYMin meet")
        .attr("viewBox", "0 0 "+width+" "+height+"");

  var projection = d3.geo.albersUsa()
    .scale(1000)
    .translate([width / 2, height / 2]);
   
  var path = d3.geo.path()
    .projection(projection);

  // Append Div for tooltip to SVG
  var tip = d3.select("#tooltip");
    
  queue()
    // .defer(d3.json, '/data/states.json')
    .defer(d3.json, '/data/us-states.json')
    .defer(d3.json, '/data/casestudies.json')
    .await(buildMap);

  function buildMap(error, states, casestudies) {

    svg.selectAll(".states")
      .data(states.features)
      .enter()
      .append("path")
      .attr("d", path)
      .attr('class', 'states')
      .attr('id', function(d) { return d.properties.name.trim(); })
      .on('click', function(d) {
        var url = "/states/"+d.properties.name.trim();
        window.location.href = url;
      });

    svg.selectAll('.study')
      .data(casestudies.features)
      .enter()
      .append('path')
      .attr('d', path.pointRadius(10))
      .attr('class', function(d) { return "study "+d.category; })
      .on("click", function(d) {
        $('#tooltip')
          .find('.title').text(d.properties.title).end()
          .find('.summary').text(d.properties.summary).end()
          .find('.button').attr('class', 'button '+d.category).end()
          .addClass('active');

        tip.style("left", (d3.event.pageX - 42) + "px")
          .style("top", (d3.event.pageY - 146) + "px");
      });
      // .on("mouseout", function(d) {
      //   tip.attr('class', 'hide')
      // });

  }
</script>

