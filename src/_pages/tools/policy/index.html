---
layout: policy_tool
title: Policy Tool
permalink: /tools/policy/
slug: state-policy

header: U.S. Food Waste Policy Finder
---

<section>
  <div class="container-fluid">
    <div class="row middle-xs center-xs">
      <div class="col-xs-12">
        <div id="map" class="map">
          {% include_relative _map_legend.html %}
        </div>
        <div id="map-instructions" class="hide">
          <div class="content">
            <h4>U.S. Food Waste Policy Finder</h4>
            <p>Use this tool to research current food waste policy at the federal and state levels and to discover best practices and recommendations for policy improvements that will support more food waste prevention, recovery and recycling.</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Controls -->
<script>

  $('#tooltip .close').on('click', function() {
    $('#tooltip').removeClass('active');
  });

  $('.map-filter, .map-subfilter').on('change', function(e) {
    var checked = $(this).prop("checked"),
        container = $(this).parent(),
        siblings = container.siblings();
    // window.console.log("CONTAINER: ", container);

    container.find('input[type="checkbox"]').prop({
      indeterminate: false,
      checked: checked
    });

    function checkSiblings(el) {

      var parent = el.parent().parent(),
          all = true;

      el.siblings().each(function() {
        return all = ($(this).children('input[type="checkbox"]').prop("checked") === checked);
      });

      if (all && checked) {

        parent.children('input[type="checkbox"]').prop({
          indeterminate: false,
          checked: checked
        });

        checkSiblings(parent);

      } else if (all && !checked) {

        parent.children('input[type="checkbox"]').prop("checked", checked);
        parent.children('input[type="checkbox"]').prop("indeterminate", (parent.find('input[type="checkbox"]:checked').length > 0));
        checkSiblings(parent);

      } else {

        el.parents("li").children('input[type="checkbox"]').prop({
          indeterminate: true,
          checked: false
        });

      }

    }

    checkSiblings(container);
    updateMapLevels();
  });

  $(".nav_category").each(function() {
    var $el = $(this),
        cat = $el.data('category');

    $el.find('.map-filter, .map-subfilter, .study-filter').on('click', function() {
      var checked = this.checked ? true : false;
      var bp = $(this).hasClass('study-filter');
      var sf = $(this).hasClass('map-subfilter');
      var activeNav = $el.find('.map-filter:checked, .map-subfilter:checked').length;
      window.console.log ($(this), bp);

      if(checked) {
        var showStudies = $el.find('.study-filter:checked').length;
        var section = $(this).closest('.section_root').attr('data-section');
        var activeClass = cat + " " + section;
        $(this).siblings('.collapse').collapse('show');

        $el.siblings('.nav_category').find('input[type="checkbox"]').prop({
          indeterminate: false,
          checked: false
        });
        if(!bp) {
          if(sf) {
            $el.find('.map-filter').not($(this).closest('.map-filter')).prop({
              indeterminate: false,
              checked: false
            });
          } else {
            $el.find('.map-filter, .map-subfilter').not(this).prop({
              indeterminate: false,
              checked: false
            });
          }
        }

        if(showStudies) {
          activeClass += " show-studies";
        }
        if(!activeNav) {
          clearLevels();
        }

        $('#map').attr('class', activeClass);

      } else {
        if(bp) { 
          $('#map').removeClass('show-studies');
        } else {
          clearLevels();
        }

      }
    });

    $el.find('.collapse').on('show.bs.collapse', function() {
      $el.siblings('.nav_category').find('.collapse').collapse('hide');
    });
  });


  function clearLevels() {
    $('path.states').removeClass(function (index, css) {
      return (css.match (/(^|\s)level-\S+/g) || []).join(' ');
    });
  }

  function getLevel(array, state) {
    return array.filter(item => item == state).length;
  }

  function updateMapLevels() {
    var activeStates = [];
    $(".map-subfilter").each(function() {
      if($(this).is(':checked')) {
        var states = $(this).data('states');
        states.forEach(function(state) {
          activeStates.push(state);
        });
      }
    });
    clearLevels();
    activeStates.forEach(function(state) {
      $('#'+state).addClass('level-'+getLevel(activeStates, state));
      // console.log(state, getLevel(activeStates, state));
    });
  }
</script>
